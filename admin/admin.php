<?php	/*	Obtiene todos los Administradores */	$sql = "SELECT id_usuario, nombre, administrador, (SELECT codigo FROM tipos_admin WHERE id_tipos_admin=administrador) as rango, (SELECT color FROM tipos_admin WHERE id_tipos_admin=administrador) as color FROM usuarios WHERE ausente='1' AND administrador>='1' ORDER BY rango ASC, id_usuario ASC";	$resul = mysqli_query($conexion, $sql);	if(!$resul){		$error = mysqli_error($conexion);		include "error.php";		exit();	}	$administradores = array();	while($fila = mysqli_fetch_array($resul)){		$administradores[] = limpiar_array($fila);	}		/*	Usuarios */	if(isset($_GET['seccion']) && $_GET['seccion'] == "usuarios"){				if($_SESSION['administrador'] < 1){			header('Location: /admin');			exit();		}				/*	Borra la victoria, derrota o desconexión de un usuario */		if(isset($_POST['borrar_victoria']) || isset($_POST['borrar_derrota']) || isset($_POST['borrar_desconexion'])){			if(isset($_POST['borrar_victoria'])){				$sql = "DELETE FROM mon_victorias WHERE id_victoria='".$_POST['borrar_id']."'";							}else if(isset($_POST['borrar_derrota'])){				$sql = "DELETE FROM mon_derrotas WHERE id_derrota='".$_POST['borrar_id']."'";							}else if(isset($_POST['borrar_desconexion'])){				$sql = "DELETE FROM mon_desconexiones WHERE id_desconexion='".$_POST['borrar_id']."'";			}			$resul = mysqli_query($conexion, $sql);			if(!$resul){				$error = mysqli_error($conexion);				include "error.php";				exit();			}		}				/* Conectar a un usuario */		if(isset($_POST['conectar_usuario'])){			$sql = "UPDATE usuarios SET online=1, ausente=1 WHERE id_usuario = '".$_POST['conectar_usuario_id']."'";			$resul = mysqli_query($conexion, $sql);			if(!$resul){				$error = mysqli_error($conexion);				include "error.php";				exit();			}		}				/* Desconectar a un usuario */		if(isset($_POST['desconectar_usuario'])){			$sql = "UPDATE usuarios SET online=0, ausente=0 WHERE id_usuario = '".$_POST['conectar_usuario_id']."'";			$resul = mysqli_query($conexion, $sql);			if(!$resul){				$error = mysqli_error($conexion);				include "error.php";				exit();			}		}				/*	Editar usuario */		if(isset($_POST['editar_usuario'])){					/* Cargamos la lista de tipos de administrador. */			$sql = "SELECT * FROM tipos_admin ORDER BY numero ASC";			$resul = mysqli_query($conexion, $sql);			if(!$resul){				$error = mysqli_error($conexion);				include "error.php";				exit();			}			$tipos_admin = array();			while ($fila = mysqli_fetch_array($resul)){				$tipos_admin[$fila['numero']] = limpiar_array($fila);			}						/* Cargamos la lista de tipos de cuenta. */			$sql = "SELECT * FROM tipos_cuenta";			$resul = mysqli_query($conexion, $sql);			if(!$resul){				$error = mysqli_error($conexion);				include "error.php";				exit();			}			$tipos_cuenta = array();			while ($fila = mysqli_fetch_array($resul)){				$tipos_cuenta[$fila['id_tipos_cuenta']] = limpiar_array($fila);			}						/* Cargamos la lista de wallpapers. */			$sql = "SELECT * FROM mon_wallpapers";			$resul = mysqli_query($conexion, $sql);			if(!$resul){				$error = mysqli_error($conexion);				include "error.php";				exit();			}			$wallpapers = array();			while ($fila = mysqli_fetch_array($resul)){				$wallpapers[$fila['id_wallpapers']] = limpiar_array($fila);			}						/* Cargamos la lista de idiomas. */			$sql = "SELECT * FROM mon_idiomas";			$resul = mysqli_query($conexion, $sql);			if(!$resul){				$error = mysqli_error($conexion);				include "error.php";				exit();			}			$editor_idiomas = array();			while ($fila = mysqli_fetch_array($resul)){				$editor_idiomas[$fila['codigo']] = limpiar_array($fila);			}						/* Cargamos los datos del usuario. */			$sql = "SELECT * FROM usuarios WHERE id_usuario = '".$_POST['modificar_usuario_id']."'";			$resul = mysqli_query($conexion, $sql);			if(!$resul){				$error = mysqli_error($conexion);				include "error.php";				exit();			}			$usuario = array();			while ($fila = mysqli_fetch_array($resul)){				$usuario = limpiar_array($fila);			}						/* Cargamos las victorias del usuario. */			$sql = "SELECT *, id_partida as partida, (SELECT inicio FROM mon_partidas_registros WHERE id_partida = partida) as inicio FROM mon_victorias WHERE id_usuario = '".$_POST['modificar_usuario_id']."'";			$resul = mysqli_query($conexion, $sql);			if(!$resul){				$error = mysqli_error($conexion);				include "error.php";				exit();			}			$victorias = array();			while ($fila = mysqli_fetch_array($resul)){				$victorias[$fila['id_victoria']] = limpiar_array($fila);			}						/* Cargamos las derrotas del usuario. */			$sql = "SELECT *, id_partida as partida, (SELECT inicio FROM mon_partidas_registros WHERE id_partida = partida) as inicio FROM mon_derrotas WHERE id_usuario = '".$_POST['modificar_usuario_id']."'";			$resul = mysqli_query($conexion, $sql);			if(!$resul){				$error = mysqli_error($conexion);				include "error.php";				exit();			}			$derrotas = array();			while ($fila = mysqli_fetch_array($resul)){				$derrotas[$fila['id_derrota']] = limpiar_array($fila);			}						/* Cargamos las desconexiones del usuario. */			$sql = "SELECT *, id_partida as partida, (SELECT inicio FROM mon_partidas_registros WHERE id_partida = partida) as inicio FROM mon_desconexiones WHERE id_usuario = '".$_POST['modificar_usuario_id']."'";			$resul = mysqli_query($conexion, $sql);			if(!$resul){				$error = mysqli_error($conexion);				include "error.php";				exit();			}			$desconexiones = array();			while ($fila = mysqli_fetch_array($resul)){				$desconexiones[$fila['id_desconexion']] = limpiar_array($fila);			}						/* Cargamos el editor. */			include "vistas/vista_editor.php"; 			exit();		}				/* Guardar los cambios hechos en un usuario. */		if(isset($_POST['aceptar_edicion'])){					/* Recogemos las variables. */			$edicion['nombre'] = 			trim(htmlspecialchars($_POST['usuario_email']));			$edicion['nombre'] = 			trim(htmlspecialchars($_POST['usuario_nombre']));			$edicion['idioma'] = 			trim(htmlspecialchars($_POST['usuario_idioma']));			$edicion['wallpaper'] = 		trim(htmlspecialchars($_POST['usuario_wallpaper']));			$edicion['tipo_cuenta'] = 		trim(htmlspecialchars($_POST['usuario_cuenta']));			$edicion['administrador'] = 	trim(htmlspecialchars($_POST['usuario_admin']));			if(!isset($edicion['administrador']) || empty($edicion['administrador'])){				$edicion['administrador'] = '0';			}			if(isset($_POST['usuario_suscrito'])){				$edicion['infoimperdible'] = 1;			}else{				$edicion['infoimperdible'] = 0;			}						/* Generamos la consulta */			$sql = "UPDATE usuarios SET ";			foreach($edicion as $clave => $valor){				if(!empty($valor) || $clave == "administrador"){					$sql .= $clave."='".$valor."', ";				}			}			$sql = substr($sql, 0, -2);			$sql .= " WHERE id_usuario = '".$_POST['modificar_usuario_id']."'";			$resul = mysqli_query($conexion, $sql);			if(!$resul){				$error = mysqli_error($conexion);				include "error.php";				exit();			}						header("Location: admin-".$_GET['seccion']);			exit();		}				/* Borrar un usuario */		if(isset($_POST['borrar_usuario'])){					/* Eliminamos el usuario */			$sql = "DELETE FROM usuarios WHERE id_usuario = '".$_POST['borrar_usuario_id']."'";			$resul = mysqli_query($conexion, $sql);			if(!$resul){				$error = mysqli_error($conexion);				include "error.php";				exit();			}		}				/* Contamos los usuarios registrados */		$sql = "SELECT count(*) as registrados FROM usuarios WHERE administrador = '0'";		$resul = mysqli_query($conexion, $sql);		if(!$resul){			$error = mysqli_error($conexion);			include "error.php";			exit();		}		while ($fila = mysqli_fetch_array($resul)){			$usuarios_registrados = $fila['registrados'];		}				/* Cargamos los datos de todos los usuarios */		$sql = "SELECT * FROM usuarios ORDER BY registrado ASC";		$resul = mysqli_query($conexion, $sql);		if(!$resul){			$error = mysqli_error($conexion);			include "error.php";			exit();		}		$usuarios = array();		while ($fila = mysqli_fetch_array($resul)){			$usuarios[] = limpiar_array($fila);		}				include "vistas/vista_usuarios.php";		exit();	}		/*	Ticket detalles */	if(isset($_GET['seccion']) && $_GET['seccion'] == "ticket" && isset($_GET['partida'])){				if($_SESSION['administrador'] < 1){			header('Location: /admin');			exit();		}				if(isset($_POST['ticket_responder'])){					$sql = "UPDATE mon_tickets SET id_admin='".$_SESSION['id_usuario']."', respuesta='".trim(htmlspecialchars($_POST['ticket_respuesta']))."' WHERE id_ticket='".$_GET['partida']."'";			$resul = mysqli_query($conexion, $sql);			if(!$resul){				$error = mysqli_error($conexion);				include "error.php";				exit();			}									header("Location: /admin-tickets");			exit();		}			$sql = "SELECT * FROM mon_tickets WHERE id_ticket='".$_GET['partida']."'";		$resul = mysqli_query($conexion, $sql);		if(!$resul){			$error = mysqli_error($conexion);			include "error.php";			exit();		}		$ticket = array();		while ($fila = mysqli_fetch_array($resul)){			$temp = limpiar_array($fila);						/*	Obtenemos el nombre del usuario que lo mandó */			$sql = "SELECT nombre FROM usuarios WHERE id_usuario='".$fila['id_usuario']."'";			$resul = mysqli_query($conexion, $sql);			if(!$resul){				$response['error'] = mysqli_error($conexion)." - ".$sql;				echo json_encode($response);				exit();			}			while($fila = mysqli_fetch_array($resul)){				$temp['nombre_usuario'] = $fila['nombre'];			}			$ticket = $temp;		}				include "vistas/vista_ticket_detalle.php";		exit();	}		/*	Control de Tickets */	if(isset($_GET['seccion']) && $_GET['seccion'] == "tickets"){				if($_SESSION['administrador'] < 1){			header('Location: /admin');			exit();		}						/* Cargamos los datos de todos los tickets */		$sql = "SELECT * FROM mon_tickets WHERE consulta != ''";		$resul = mysqli_query($conexion, $sql);		if(!$resul){			$error = mysqli_error($conexion);			include "error.php";			exit();		}		$temp_tickets = array();		while ($fila = mysqli_fetch_array($resul)){			$temp_tickets[] = limpiar_array($fila);		}				$tickets = array();		foreach($temp_tickets as $temp){					/*	Obtenemos el nombre del usuario que lo mandó */			$sql2 = "SELECT nombre FROM usuarios WHERE id_usuario='".$temp['id_usuario']."'";			$resul2 = mysqli_query($conexion, $sql2);			if(!$resul2){				$response['error'] = mysqli_error($conexion)." - ".$sql2;				echo json_encode($response);				exit();			}			while($fila2 = mysqli_fetch_array($resul2)){				$temp['nombre_usuario'] = $fila2['nombre'];			}						/*	Obtenemos el nombre del admin que lo respondió */			if($temp['id_admin'] != "" && $temp['id_admin'] != "0"){				$sql3 = "SELECT nombre FROM usuarios WHERE id_usuario='".$temp['id_admin']."'";				$resul3 = mysqli_query($conexion, $sql3);				if(!$resul3){					$response['error'] = mysqli_error($conexion)." - ".$sql3;					echo json_encode($response);					exit();				}				while($fila3 = mysqli_fetch_array($resul3)){					$temp['nombre_admin'] = $fila3['nombre'];				}			}			$tickets[] = $temp;		}						include "vistas/vista_tickets.php";		exit();	}		/*	Control de IPs */	if(isset($_GET['seccion']) && $_GET['seccion'] == "ips"){				if($_SESSION['administrador'] < 1){			header('Location: /admin');			exit();		}				/* Cargamos los datos de todos los avatares */		$sql = "SELECT ip_ultima_conexion FROM usuarios GROUP BY ip_ultima_conexion";		$resul = mysqli_query($conexion, $sql);		if(!$resul){			$error = mysqli_error($conexion);			include "error.php";			exit();		}		$ip_temp = array();		while ($fila = mysqli_fetch_array($resul)){			$ip_temp[] = limpiar_array($fila);		}				$grupos_ip = array();		foreach($ip_temp as $temp){			$sql = "SELECT id_usuario as user, ip_ultima_conexion as ultima_ip, nombre, email, administrador, (SELECT count(*) FROM mon_victorias WHERE id_usuario=user) as victorias, (SELECT count(*) FROM mon_derrotas WHERE id_usuario=user) as derrotas, (SELECT count(*) FROM mon_desconexiones WHERE id_usuario=user) as desconexiones, (SELECT count(*) FROM usuarios WHERE ip_ultima_conexion=ultima_ip) as repeticiones FROM usuarios WHERE ip_ultima_conexion='".$temp['ip_ultima_conexion']."' AND administrador = '0' ORDER BY repeticiones DESC";			$resul = mysqli_query($conexion, $sql);			if(!$resul){				$error = mysqli_error($conexion);				include "error.php";				exit();			}			$grupo = array();			while($fila = mysqli_fetch_array($resul)){				$grupo[$fila['user']] = limpiar_array($fila);			}			if(sizeof($grupo) > 1){				$grupos_ip[] = $grupo;			}		}				function cmp($a, $b){			return (count($b) - count($a));		}		usort($grupos_ip, 'cmp');				include "vistas/vista_ips.php";		exit();	}		/*	Control de Finales */	if(isset($_GET['seccion']) && $_GET['seccion'] == "finales"){		function cmp($a, $b){			return (count($b) - count($a));		}				if($_SESSION['administrador'] < 1){			header('Location: /admin');			exit();		}				if(isset($_POST['borrar_partida']) || isset($_POST['borrar_victoria']) || isset($_POST['borrar_derrota']) || isset($_POST['borrar_desconexion'])){			if(isset($_POST['borrar_partida'])){				$sql = "DELETE FROM mon_partidas_registros WHERE id_registro='".$_POST['borrar_id']."'";							}else if(isset($_POST['borrar_victoria'])){				$sql = "DELETE FROM mon_victorias WHERE id_victoria='".$_POST['borrar_id']."'";							}else if(isset($_POST['borrar_derrota'])){				$sql = "DELETE FROM mon_derrotas WHERE id_derrota='".$_POST['borrar_id']."'";							}else if(isset($_POST['borrar_desconexion'])){				$sql = "DELETE FROM mon_desconexiones WHERE id_desconexion='".$_POST['borrar_id']."'";			}			$resul = mysqli_query($conexion, $sql);			if(!$resul){				$error = mysqli_error($conexion);				include "error.php";				exit();			}		}				/* Cargamos los datos de todas las partidas */		$sql = "SELECT * FROM mon_partidas_registros ORDER BY id_partida ASC, id_registro ASC";		$resul = mysqli_query($conexion, $sql);		if(!$resul){			$error = mysqli_error($conexion);			include "error.php";			exit();		}		$partidas = array();		while ($fila = mysqli_fetch_array($resul)){			$partidas[$fila['id_partida']][] = limpiar_array($fila);		}				/* Cargamos los datos de todas las victorias */		$sql = "SELECT *, id_usuario as user, (SELECT nombre FROM usuarios WHERE id_usuario=user) as nombre, (SELECT email FROM usuarios WHERE id_usuario=user) as email FROM mon_victorias";		$resul = mysqli_query($conexion, $sql);		if(!$resul){			$error = mysqli_error($conexion);			include "error.php";			exit();		}		$vic_temp = array();		while ($fila = mysqli_fetch_array($resul)){			$vic_temp[$fila['id_usuario']][$fila['id_partida']][$fila['id_victoria']] = limpiar_array($fila);		}				usort($vic_temp, 'cmp');				/* Cargamos los datos de todas las derrotas */		$sql = "SELECT *, id_usuario as user, (SELECT nombre FROM usuarios WHERE id_usuario=user) as nombre, (SELECT email FROM usuarios WHERE id_usuario=user) as email FROM mon_derrotas";		$resul = mysqli_query($conexion, $sql);		if(!$resul){			$error = mysqli_error($conexion);			include "error.php";			exit();		}		$derr_temp = array();		while ($fila = mysqli_fetch_array($resul)){			$derr_temp[$fila['id_usuario']][$fila['id_partida']][$fila['id_derrota']] = limpiar_array($fila);		}				usort($derr_temp, 'cmp');				/* Cargamos los datos de todas las desconeiones */		$sql = "SELECT *, id_usuario as user, (SELECT nombre FROM usuarios WHERE id_usuario=user) as nombre, (SELECT email FROM usuarios WHERE id_usuario=user) as email FROM mon_desconexiones";		$resul = mysqli_query($conexion, $sql);		if(!$resul){			$error = mysqli_error($conexion);			include "error.php";			exit();		}		$desc_temp = array();		while ($fila = mysqli_fetch_array($resul)){			$desc_temp[$fila['id_usuario']][$fila['id_partida']][$fila['id_desconexion']] = limpiar_array($fila);		}				usort($desc_temp, 'cmp');				include "vistas/vista_control_finales.php";		exit();	}		/*	Baneos */	if(isset($_GET['seccion']) && $_GET['seccion'] == "baneos"){				if($_SESSION['administrador'] < 2){			header('Location: /admin');			exit();		}						if(isset($_POST['ban_borrar'])){					/* Seleccionamos las cabeceras de la tabla mensajes */			$sql = "DELETE FROM mon_baneados WHERE id_ban='".$_POST['ban_id']."'";			$resul = mysqli_query($conexion, $sql);			if(!$resul){				$error = mysqli_error($conexion);				include "error.php";				exit();			}		}				/* Cargamos los datos de todos los avatares */		$sql = "SELECT * FROM mon_baneados ORDER BY id_ban DESC";		$resul = mysqli_query($conexion, $sql);		if(!$resul){			$error = mysqli_error($conexion);			include "error.php";			exit();		}		$ban_temp = array();		while ($fila = mysqli_fetch_array($resul)){			$ban_temp[] = limpiar_array($fila);		}				$baneos = array();		foreach($ban_temp as $temp){			if(preg_match("/\./", $temp['id_usuario'])){				$sql = "SELECT id_usuario as user, nombre, ip_ultima_conexion FROM usuarios WHERE ip_ultima_conexion='".$temp['id_usuario']."'";				$tipo = "IP";			}else{				$sql = "SELECT id_usuario as user, nombre, ip_ultima_conexion FROM usuarios WHERE id_usuario='".$temp['id_usuario']."'";				$tipo = "Cuenta";			}			$resul = mysqli_query($conexion, $sql);			if(!$resul){				$error = mysqli_error($conexion);				include "error.php";				exit();			}			$temp2 = array();			while($fila = mysqli_fetch_array($resul)){				$baneos[$fila['user']] = limpiar_array($fila);				$baneos[$fila['user']]['id_ban'] = $temp['id_ban'];				$baneos[$fila['user']]['tipo'] = $tipo;				$baneos[$fila['user']]['inicio'] = $temp['inicio'];				$baneos[$fila['user']]['fin'] = $temp['fin'];				$baneos[$fila['user']]['motivo'] = $temp['motivo'];			}		}				include "vistas/vista_baneos.php";		exit();	}		/*	Mesas */	if(isset($_GET['seccion']) && $_GET['seccion'] == "mesas"){				if($_SESSION['administrador'] < 2){			header('Location: /admin');			exit();		}						if(isset($_POST['borrar_mesa'])){					/* Eliminamos los datos de la mesa */			$sql = "DELETE FROM mon_mesas WHERE id_mesa='".$_POST['borrar_mesa_id']."'";			$resul = mysqli_query($conexion, $sql);			if(!$resul){				$error = mysqli_error($conexion);				include "error.php";				exit();			}					/* Eliminamos los chats referentes a esa mesa */			$sql = "DELETE FROM mon_chat WHERE id_mesa='".$_POST['borrar_mesa_id']."'";			$resul = mysqli_query($conexion, $sql);			if(!$resul){				$error = mysqli_error($conexion);				include "error.php";				exit();			}		}				/* Cargamos los datos de todos los avatares */		$sql = "SELECT * FROM mon_avatares";		$resul = mysqli_query($conexion, $sql);		if(!$resul){			$error = mysqli_error($conexion);			include "error.php";			exit();		}		$avatares = array();		while ($fila = mysqli_fetch_array($resul)){			$avatares[$fila['id_avatares']] = limpiar_array($fila);		}				/* Cargamos los datos de todas las mesas */		$sql = "SELECT * FROM mon_mesas WHERE jugando=0";		$resul = mysqli_query($conexion, $sql);		if(!$resul){			$error = mysqli_error($conexion);			include "error.php";			exit();		}		$mesas = array();		$mesas2 = array();		while ($fila = mysqli_fetch_array($resul)){			foreach($fila as $clave => $valor){				if($clave == "jugador1" || $clave == "jugador2" || $clave == "jugador3" || $clave == "jugador4"){					$sql_2 = "SELECT nombre FROM usuarios where id_usuario='".$valor."'";					$resul_2 = mysqli_query($conexion, $sql_2);					if(!$resul_2){						$error = mysqli_error($conexion);						include "error.php";						exit();					}					while ($fila_2 = mysqli_fetch_array($resul_2)){						$fila[$clave."nombre"] = $fila_2["nombre"];					}				}			}			$mesas[$fila['id_mesa']] = limpiar_array($fila);		}				include "vistas/vista_mesas.php";		exit();	}		/*	Partida detalle */	if(isset($_GET['seccion']) && $_GET['seccion'] == "partida" && isset($_GET['partida'])){				if($_SESSION['administrador'] < 2){			header('Location: /admin');			exit();		}				if(isset($_POST['jugador_expulsar'])){						/*	Le entrega las propiedades al banco */			$sql = "UPDATE mon_partidas_propiedades SET id_propietario = '0' WHERE id_propietario = '".$_POST['jugador_id']."'";			$resul = mysqli_query($conexion, $sql);			if(!$resul){				$error = mysqli_error($conexion);				include "error.php";				exit();			}						/*	Le entrega las tarjetas al banco */			$sql = "UPDATE mon_partidas_comunidades SET propietario = '0' WHERE propietario = '".$_POST['jugador_id']."'";			$resul = mysqli_query($conexion, $sql);			if(!$resul){				$error = mysqli_error($conexion);				include "error.php";				exit();			}						$sql = "UPDATE mon_partidas_suertes SET propietario = '0' WHERE propietario = '".$_POST['jugador_id']."'";			$resul = mysqli_query($conexion, $sql);			if(!$resul){				$error = mysqli_error($conexion);				include "error.php";				exit();			}					/*	Borra al jugador de la partida */			$sql = "DELETE FROM mon_partidas_jugadores WHERE id_jugador = '".$_POST['jugador_id']."'";			$resul = mysqli_query($conexion, $sql);			if(!$resul){				$error = mysqli_error($conexion);				include "error.php";				exit();			}						/*	Borra al jugador de la mesa */			$sql = "UPDATE mon_mesas SET ".$_POST['jugador_orden']." = NULL, ".$_POST['jugador_orden']."ok = NULL, ".$_POST['jugador_orden']."avatar = '0' WHERE id_mesa = '".$_GET['partida']."'";			$resul = mysqli_query($conexion, $sql);			if(!$resul){				$error = mysqli_error($conexion);				include "error.php";				exit();			}		}			$partida = array();				/* Cargamos los datos de la mesa */		$sql = "SELECT * FROM mon_mesas WHERE id_mesa='".$_GET['partida']."'";		$resul = mysqli_query($conexion, $sql);		if(!$resul){			$error = mysqli_error($conexion);			include "error.php";			exit();		}		while ($fila = mysqli_fetch_array($resul)){			foreach($fila as $clave => $valor){				if($clave == "jugador1" || $clave == "jugador2" || $clave == "jugador3" || $clave == "jugador4"){										/*	Cargamos los datos de los jugadores */					$sql_2 = "SELECT *, (SELECT nombre FROM usuarios WHERE id_usuario='".$valor."') as nombre, (SELECT ausente FROM usuarios WHERE id_usuario='".$valor."') as ausente, (SELECT online FROM usuarios WHERE id_usuario='".$valor."') as online, (SELECT fecha_ultima_conexion FROM usuarios WHERE id_usuario='".$valor."') as ultimo_mov, (SELECT ip_ultima_conexion FROM usuarios WHERE id_usuario='".$valor."') as utima_ip FROM mon_partidas_jugadores WHERE id_jugador='".$valor."' AND id_partida='".$_GET['partida']."'";					$resul_2 = mysqli_query($conexion, $sql_2);					if(!$resul_2){						$error = mysqli_error($conexion);						include "error.php";						exit();					}					while ($fila_2 = mysqli_fetch_array($resul_2)){						if($fila_2['online'] == 1 && $fila_2['ausente'] == 1){		$fila_2['estado'] = "online";}						else if($fila_2['online'] == 0 && $fila_2['ausente'] == 1){	$fila_2['estado'] = "online-aus";}						else{														$fila_2['estado'] = "offline";}						$partida['jugadores'][$valor] = limpiar_array($fila_2);					}				}			}			$partida['mesa'] = limpiar_array($fila);		}				/* Cargamos los datos de las casillas */		$sql = "SELECT *, id_casilla as casilla, (SELECT madrid FROM mon_calles WHERE id_calles=casilla) as nombre, (SELECT color FROM mon_calles WHERE id_calles=casilla) as color FROM mon_partidas_propiedades WHERE id_partida='".$_GET['partida']."' ORDER BY id_propietario DESC, id_casilla ASC";		$resul = mysqli_query($conexion, $sql);		if(!$resul){			$error = mysqli_error($conexion);			include "error.php";			exit();		}		while ($fila = mysqli_fetch_array($resul)){			$partida['propiedades'][$fila['id_casilla']] = limpiar_array($fila);		}				/* Cargamos los datos de las conversaciones */		$sql = "SELECT * FROM mon_chat WHERE id_mesa='".$_GET['partida']."' ORDER BY id_chat DESC";		$resul = mysqli_query($conexion, $sql);		if(!$resul){			$error = mysqli_error($conexion);			include "error.php";			exit();		}		while ($fila = mysqli_fetch_array($resul)){			$partida['chat'][] = limpiar_array($fila);		}				/* Cargamos los datos de las notificaciones */		$sql = "SELECT * FROM mon_notificaciones WHERE id_partida='".$_GET['partida']."' ORDER BY id_notificacion DESC";		$resul = mysqli_query($conexion, $sql);		if(!$resul){			$error = mysqli_error($conexion);			include "error.php";			exit();		}		while ($fila = mysqli_fetch_array($resul)){			$partida['notificaciones'][] = limpiar_array($fila);		}				include "vistas/vista_partida_detalle.php";		exit();	}		/*	Partidas */	if(isset($_GET['seccion']) && $_GET['seccion'] == "partidas"){				if($_SESSION['administrador'] < 2){			header('Location: /admin');			exit();		}						if(isset($_POST['borrar_partida'])){						/*	Establecemos el motivo del final de la partida */			$sql = "UPDATE mon_partidas_registros SET motivo='Partida cerrada por ".$_SESSION['nombre'].".' WHERE id_partida='".$_POST['partida_id']."'";			$resul = mysqli_query($conexion, $sql);			if(!$resul){				$error = mysqli_error($conexion);				include "error.php";				exit();			}						/* Eliminamos los datos de la partida */			$sql = "DELETE FROM mon_mesas WHERE id_mesa='".$_POST['partida_id']."'";			$resul = mysqli_query($conexion, $sql);			if(!$resul){				$error = mysqli_error($conexion);				include "error.php";				exit();			}					/* Eliminamos los jugadores referentes a esa partida */			$sql = "DELETE FROM mon_partidas_jugadores WHERE id_partida='".$_POST['partida_id']."'";			$resul = mysqli_query($conexion, $sql);			if(!$resul){				$error = mysqli_error($conexion);				include "error.php";				exit();			}					/* Eliminamos los espectadores referentes a esa partida */			$sql = "DELETE FROM mon_espectadores WHERE id_mesa='".$_POST['partida_id']."'";			$resul = mysqli_query($conexion, $sql);			if(!$resul){				$error = mysqli_error($conexion);				include "error.php";				exit();			}					/* Eliminamos las propiedades referentes a esa partida */			$sql = "DELETE FROM mon_partidas_propiedades WHERE id_partida='".$_POST['partida_id']."'";			$resul = mysqli_query($conexion, $sql);			if(!$resul){				$error = mysqli_error($conexion);				include "error.php";				exit();			}					/* Eliminamos las suertes referentes a esa partida */			$sql = "DELETE FROM mon_partidas_suertes WHERE id_partida='".$_POST['partida_id']."'";			$resul = mysqli_query($conexion, $sql);			if(!$resul){				$error = mysqli_error($conexion);				include "error.php";				exit();			}					/* Eliminamos las comunidades referentes a esa partida */			$sql = "DELETE FROM mon_partidas_comunidades WHERE id_partida='".$_POST['partida_id']."'";			$resul = mysqli_query($conexion, $sql);			if(!$resul){				$error = mysqli_error($conexion);				include "error.php";				exit();			}					/* Eliminamos las notificaciones referentes a esa partida */			$sql = "DELETE FROM mon_notificaciones WHERE id_partida='".$_POST['partida_id']."'";			$resul = mysqli_query($conexion, $sql);			if(!$resul){				$error = mysqli_error($conexion);				include "error.php";				exit();			}					/* Eliminamos las negociaciones referentes a esa partida */			$sql = "DELETE FROM mon_negociaciones WHERE id_partida='".$_POST['partida_id']."'";			$resul = mysqli_query($conexion, $sql);			if(!$resul){				$error = mysqli_error($conexion);				include "error.php";				exit();			}					/* Eliminamos los chats referentes a esa partida */			$sql = "DELETE FROM mon_chat WHERE id_mesa='".$_POST['partida_id']."'";			$resul = mysqli_query($conexion, $sql);			if(!$resul){				$error = mysqli_error($conexion);				include "error.php";				exit();			}		}				/* Cargamos los datos de todas las partidas */		$sql = "SELECT *, id_mesa as partida, (SELECT fecha FROM mon_notificaciones WHERE id_partida=partida ORDER BY fecha DESC LIMIT 1) as ultima_fecha, (SELECT texto FROM mon_notificaciones WHERE id_partida=partida ORDER BY fecha DESC LIMIT 1) as ultimo_mensaje FROM mon_mesas WHERE jugando=1";		$resul = mysqli_query($conexion, $sql);		if(!$resul){			$error = mysqli_error($conexion);			include "error.php";			exit();		}		$mesas = array();		while ($fila = mysqli_fetch_array($resul)){			foreach($fila as $clave => $valor){				if($clave == "jugador1" || $clave == "jugador2" || $clave == "jugador3" || $clave == "jugador4"){					$sql_2 = "SELECT nombre FROM usuarios where id_usuario='".$valor."'";					$resul_2 = mysqli_query($conexion, $sql_2);					if(!$resul_2){						$error = mysqli_error($conexion);						include "error.php";						exit();					}					while ($fila_2 = mysqli_fetch_array($resul_2)){						$fila[$clave."nombre"] = $fila_2["nombre"];					}				}			}			$mesas[$fila['id_mesa']] = limpiar_array($fila);		}				include "vistas/vista_partidas.php";		exit();	}	/*	Histórico */	if(isset($_GET['seccion']) && $_GET['seccion'] == "historico"){				if($_SESSION['administrador'] < 1){			header('Location: /admin');			exit();		}						/* Cargamos los datos de todas las partidas */		$sql = "SELECT * FROM mon_partidas_registros ORDER BY id_partida DESC";		$resul = mysqli_query($conexion, $sql);		if(!$resul){			$error = mysqli_error($conexion);			include "error.php";			exit();		}		$mesas = array();		while ($fila = mysqli_fetch_array($resul)){			if(preg_match("/ganada/", $fila['motivo'])){				foreach($fila as $clave => $valor){					if($clave == "jugador1" || $clave == "jugador2" || $clave == "jugador3" || $clave == "jugador4"){						$sql_2 = "SELECT nombre FROM usuarios where id_usuario='".$valor."'";						$resul_2 = mysqli_query($conexion, $sql_2);						if(!$resul_2){							$error = mysqli_error($conexion);							include "error.php";							exit();						}						while ($fila_2 = mysqli_fetch_array($resul_2)){							$fila[$clave."nombre"] = $fila_2["nombre"];						}					}				}				$mesas[$fila['id_partida']] = limpiar_array($fila);			}		}				include "vistas/vista_historico.php";		exit();	}	/*	Logros */	if(isset($_GET['seccion']) && $_GET['seccion'] == "logros"){				if($_SESSION['administrador'] < 3){			header('Location: /admin');			exit();		}				if(isset($_POST['nuevo_logro'])){					/* Buscamos si existe el elemento que queremos crear */			$sql = "SELECT * FROM logros WHERE id_logro = '".$_POST['logro_id_logro']."'";			$resul = mysqli_query($conexion, $sql);			if(!$resul){				$error = mysqli_error($conexion);				include "error.php";				exit();			}			$logros = array();			while ($fila = mysqli_fetch_array($resul)){				$logros[] = limpiar_array($fila);			}						/* Si no hay ningún elemento con ese ID, lo creamos */			if(empty($logros)){							/* Seleccionamos las cabeceras de la tabla */				$sql = "SELECT * FROM logros LIMIT 1";				$resul = mysqli_query($conexion, $sql);				if(!$resul){					$error = mysqli_error($conexion);					include "error.php";					exit();				}				$logros = array();				while ($fila = mysqli_fetch_array($resul)){					$logros[] = limpiar_array($fila);				}							/* Generamos las variables que se van a insertar en la consulta */				foreach($logros['0'] as $clave => $valor){					if($clave != "id_logro" && !empty($valor) && $valor != ""){						$nuevo[$clave] = trim(htmlspecialchars($_POST['logro_'.$clave]));					}				}								/* Generamos la consulta */				$sql = "INSERT INTO logros (";				foreach($nuevo as $clave => $valor){					$sql .= $clave.", ";				}				$sql = substr($sql, 0, -2);				$sql .= ") VALUES (";				foreach($nuevo as $clave => $valor){					$sql .= "'".$valor."', ";				}				$sql = substr($sql, 0, -2);				$sql .= ")";			}						/* Si existe, lo actualizamos */			else{								/* Generamos las variables que se van a insertar en la consulta. */				/* Si están vacías no se incluyen. */				foreach($logros['0'] as $clave => $valor){					if(						($clave != "logro_id_logro") && 						(!empty($_POST['logro_'.$clave])) && 						($_POST['logro_'.$clave] != "")					){						$nuevo[$clave] = trim(htmlspecialchars($_POST['logro_'.$clave]));					}				}								/* Generamos la consulta */				$sql = "UPDATE logros SET ";				foreach($nuevo as $clave => $valor){					$sql .= $clave."='".$valor."', ";				}				$sql = substr($sql, 0, -2);				$sql .= " WHERE id_logro = '".$_POST['logro_id_logro']."'";			}						/* Damos la orden a sql */			$resul = mysqli_query($conexion, $sql);			if(!$resul){				$error = mysqli_error($conexion);				include "error.php";				exit();			}		}				if(isset($_POST['borrar_logro'])){					/* Seleccionamos las cabeceras de la tabla idiomas */			$sql = "DELETE FROM logros WHERE id_logro='".$_POST['borrar_logro_id']."'";			$resul = mysqli_query($conexion, $sql);			if(!$resul){				$error = mysqli_error($conexion);				include "error.php";				exit();			}		}				/* Cargamos los datos de todos los logros */		$sql = "SELECT * FROM logros ORDER BY categoria ASC, seccion ASC, id_logro ASC";		$resul = mysqli_query($conexion, $sql);		if(!$resul){			$error = mysqli_error($conexion);			include "error.php";			exit();		}		$logros = array();		while ($fila = mysqli_fetch_array($resul)){			$logros[] = limpiar_array($fila);		}				include "vistas/vista_logros.php";		exit();	}	/*	Avatares */	if(isset($_GET['seccion']) && $_GET['seccion'] == "avatares"){				if($_SESSION['administrador'] < 3){			header('Location: /admin');			exit();		}				if(isset($_POST['nuevo_avatar'])){					/* Buscamos si existe el elemento que queremos crear */			$sql = "SELECT * FROM mon_avatares WHERE ruta = '".$_POST['avatar_ruta']."'";			$resul = mysqli_query($conexion, $sql);			if(!$resul){				$error = mysqli_error($conexion);				include "error.php";				exit();			}			$avatares = array();			while ($fila = mysqli_fetch_array($resul)){				$avatares[] = limpiar_array($fila);			}						/* Si no hay ningún elemento con ese ID, lo creamos */			if(empty($avatares)){							/* Seleccionamos las cabeceras de la tabla */				$sql = "SELECT * FROM mon_avatares LIMIT 1";				$resul = mysqli_query($conexion, $sql);				if(!$resul){					$error = mysqli_error($conexion);					include "error.php";					exit();				}				$avatares = array();				while ($fila = mysqli_fetch_array($resul)){					$avatares[] = limpiar_array($fila);				}							/* Generamos las variables que se van a insertar en la consulta */				foreach($avatares['0'] as $clave => $valor){					if($clave != "id_avatares" && !empty($valor) && $valor != ""){						$nuevo[$clave] = trim(htmlspecialchars($_POST['avatar_'.$clave]));					}				}								/* Generamos la consulta */				$sql = "INSERT INTO mon_avatares (";				foreach($nuevo as $clave => $valor){					$sql .= $clave.", ";				}				$sql = substr($sql, 0, -2);				$sql .= ") VALUES (";				foreach($nuevo as $clave => $valor){					$sql .= "'".$valor."', ";				}				$sql = substr($sql, 0, -2);				$sql .= ")";						/* Si existe, lo actualizamos */			}else{								/* Generamos las variables que se van a insertar en la consulta. */				/* Si están vacías no se incluyen. */				foreach($avatares['0'] as $clave => $valor){					if(						($clave != "id_avatares") && 						($clave != "ruta") && 						(!empty($_POST['avatar_'.$clave])) && 						($_POST['avatar_'.$clave] != "")					){						$nuevo[$clave] = trim(htmlspecialchars($_POST['avatar_'.$clave]));					}				}								/* Generamos la consulta */				$sql = "UPDATE mon_avatares SET ";				foreach($nuevo as $clave => $valor){					$sql .= $clave."='".$valor."', ";				}				$sql = substr($sql, 0, -2);				$sql .= " WHERE ruta = '".$_POST['avatar_ruta']."'";			}						/* Damos la orden a sql */			$resul = mysqli_query($conexion, $sql);			if(!$resul){				$error = mysqli_error($conexion);				include "error.php";				exit();			}		}				if(isset($_POST['borrar_avatar'])){					/* Seleccionamos las cabeceras de la tabla idiomas */			$sql = "DELETE FROM mon_avatares WHERE id_avatares='".$_POST['borrar_avatar_id']."'";			$resul = mysqli_query($conexion, $sql);			if(!$resul){				$error = mysqli_error($conexion);				include "error.php";				exit();			}		}				/* Cargamos los datos de todos los avatares */		$sql = "SELECT * FROM mon_avatares ORDER BY ruta";		$resul = mysqli_query($conexion, $sql);		if(!$resul){			$error = mysqli_error($conexion);			include "error.php";			exit();		}		$avatares = array();		while ($fila = mysqli_fetch_array($resul)){			$avatares[] = limpiar_array($fila);		}				include "vistas/vista_fichas.php";		exit();	}	/*	Calles */	if(isset($_GET['seccion']) && $_GET['seccion'] == "calles"){				if($_SESSION['administrador'] < 3){			header('Location: /admin');			exit();		}			if(isset($_POST['nueva_calle'])){					/* Buscamos si existe el elemento que queremos crear */			$sql = "SELECT * FROM mon_calles WHERE id_calles = '".$_POST['calle_idcalles']."'";			$resul = mysqli_query($conexion, $sql);			if(!$resul){				$error = mysqli_error($conexion);				include "error.php";				exit();			}			$calles = array();			while ($fila = mysqli_fetch_array($resul)){				$calles[] = limpiar_array($fila);			}						/* Si no hay ninguna calle con ese ID, la creamos */			if(empty($calles)){							/* Seleccionamos las cabeceras de la tabla calles */				$sql = "SELECT * FROM mon_calles LIMIT 1";				$resul = mysqli_query($conexion, $sql);				if(!$resul){					$error = mysqli_error($conexion);					include "error.php";					exit();				}				$calles = array();				while ($fila = mysqli_fetch_array($resul)){					$calles[] = limpiar_array($fila);				}							/* Generamos las variables que se van a insertar en la consulta */				foreach($calles['0'] as $clave => $valor){					if(!empty($valor) && $valor != ""){						$nuevo[$clave] = trim(htmlspecialchars($_POST['calle_'.$clave]));					}				}								/* Generamos la consulta */				$sql = "INSERT INTO mon_calles (";				foreach($nuevo as $clave => $valor){					$sql .= $clave.", ";				}				$sql = substr($sql, 0, -2);				$sql .= ") VALUES (";				foreach($nuevo as $clave => $valor){					$sql .= "'".$valor."', ";				}				$sql = substr($sql, 0, -2);				$sql .= ")";						/* Si existe, lo actualizamos */			}else{								/* Generamos las variables que se van a insertar en la consulta. */				/* Si están vacías no se incluyen. */				foreach($calles['0'] as $clave => $valor){					if(						($clave != "id_calles") && 						(!empty($_POST['calle_'.$clave])) && 						($_POST['calle_'.$clave] != "")					){						$nuevo[$clave] = trim(htmlspecialchars($_POST['calle_'.$clave]));					}				}								/* Generamos la consulta */				$sql = "UPDATE mon_calles SET ";				foreach($nuevo as $clave => $valor){					$sql .= $clave."='".$valor."', ";				}				$sql = substr($sql, 0, -2);				$sql .= " WHERE id_calles = '".$_POST['calle_idcalles']."'";			}						/* Damos la orden a sql */			$resul = mysqli_query($conexion, $sql);			if(!$resul){				$error = mysqli_error($conexion);				include "error.php";				exit();			}		}				if(isset($_POST['borrar_calle'])){					/* Seleccionamos las cabeceras de la tabla calles */			$sql = "DELETE FROM mon_calles WHERE id_calles='".$_POST['borrar_calle_id']."'";			$resul = mysqli_query($conexion, $sql);			if(!$resul){				$error = mysqli_error($conexion);				include "error.php";				exit();			}		}				/* Cargamos los datos de todas las calles */		$sql = "SELECT * FROM mon_calles";		$resul = mysqli_query($conexion, $sql);		if(!$resul){			$error = mysqli_error($conexion);			include "error.php";			exit();		}		$calles = array();		while ($fila = mysqli_fetch_array($resul)){			$calles[] = limpiar_array($fila);		}				include "vistas/vista_calles.php";		exit();	}	/*	Idiomas */	if(isset($_GET['seccion']) && $_GET['seccion'] == "idiomas"){				if($_SESSION['administrador'] < 3){			header('Location: /admin');			exit();		}				if(isset($_POST['nuevo_idioma'])){					/* Buscamos si existe el elemento que queremos crear */			$sql = "SELECT * FROM mon_idiomas WHERE codigo = '".$_POST['idioma_codigo']."'";			$resul = mysqli_query($conexion, $sql);			if(!$resul){				$error = mysqli_error($conexion);				include "error.php";				exit();			}			$idiomas = array();			while ($fila = mysqli_fetch_array($resul)){				$idiomas[] = limpiar_array($fila);			}						/* Si no hay ningún elemento con ese ID, lo creamos */			if(empty($idiomas)){							/* Seleccionamos las cabeceras de la tabla */				$sql = "SELECT * FROM mon_idiomas LIMIT 1";				$resul = mysqli_query($conexion, $sql);				if(!$resul){					$error = mysqli_error($conexion);					include "error.php";					exit();				}				$idiomas = array();				while ($fila = mysqli_fetch_array($resul)){					$idiomas[] = limpiar_array($fila);				}								/* Generamos las variables que se van a insertar en la consulta */				foreach($idiomas['0'] as $clave => $valor){					if($clave != "id_idiomas"){						$nuevo[$clave] = trim(htmlspecialchars($_POST['idioma_'.$clave]));					}				}								/* Generamos la consulta */				$sql = "INSERT INTO mon_idiomas (";				foreach($nuevo as $clave => $valor){					$sql .= $clave.", ";				}				$sql = substr($sql, 0, -2);				$sql .= ") VALUES (";				foreach($nuevo as $clave => $valor){					$sql .= "'".$valor."', ";				}				$sql = substr($sql, 0, -2);				$sql .= ")";						/* Si existe, lo actualizamos */			}else{								/* Generamos las variables que se van a insertar en la consulta. */				/* Si están vacías no se incluyen. */				foreach($idiomas['0'] as $clave => $valor){					if(						($clave != "id_idiomas") && 						($clave != "codigo") && 						(!empty($_POST['idioma_'.$clave])) && 						($_POST['idioma_'.$clave] != "")					){						$nuevo[$clave] = trim(htmlspecialchars($_POST['idioma_'.$clave]));					}				}								/* Generamos la consulta */				$sql = "UPDATE mon_idiomas SET ";				foreach($nuevo as $clave => $valor){					$sql .= $clave."='".$valor."', ";				}				$sql = substr($sql, 0, -2);				$sql .= " WHERE codigo = '".$_POST['idioma_codigo']."'";			}						/* Damos la orden a sql */			$resul = mysqli_query($conexion, $sql);			if(!$resul){				$error = mysqli_error($conexion);				include "error.php";				exit();			}		}				if(isset($_POST['borrar_idioma'])){					/* Seleccionamos las cabeceras de la tabla idiomas */			$sql = "DELETE FROM mon_idiomas WHERE id_idiomas='".$_POST['borrar_idioma_id']."'";			$resul = mysqli_query($conexion, $sql);			if(!$resul){				$error = mysqli_error($conexion);				include "error.php";				exit();			}		}				/* Cargamos los datos de todos los idiomas */		$sql = "SELECT * FROM mon_idiomas";		$resul = mysqli_query($conexion, $sql);		if(!$resul){			$error = mysqli_error($conexion);			include "error.php";			exit();		}		$idiomas = array();		while ($fila = mysqli_fetch_array($resul)){			$idiomas[] = limpiar_array($fila);		}		include "vistas/vista_idiomas.php";		exit();	}		/*	Tarjetas */	if(isset($_GET['seccion']) && $_GET['seccion'] == "tarjetas"){				if($_SESSION['administrador'] < 3){			header('Location: /admin');			exit();		}			if(isset($_POST['nueva_tarjeta'])){					/* Buscamos si existe el elemento que queremos crear */			$sql = "SELECT * FROM mon_tarjetas WHERE id_tarjetas = '".$_POST['tarjeta_idtarjetas']."'";			$resul = mysqli_query($conexion, $sql);			if(!$resul){				$error = mysqli_error($conexion);				include "error.php";				exit();			}			$tarjetas = array();			while ($fila = mysqli_fetch_array($resul)){				$tarjetas[] = limpiar_array($fila);			}						/* Si no hay ninguna tarjeta con ese ID, la creamos */			if(empty($tarjetas)){							/* Seleccionamos las cabeceras de la tabla tarjetas */				$sql = "SELECT * FROM mon_tarjetas LIMIT 1";				$resul = mysqli_query($conexion, $sql);				if(!$resul){					$error = mysqli_error($conexion);					include "error.php";					exit();				}				$tarjetas = array();				while ($fila = mysqli_fetch_array($resul)){					$tarjetas[] = limpiar_array($fila);				}							/* Generamos las variables que se van a insertar en la consulta */				foreach($tarjetas['0'] as $clave => $valor){					if(!empty($valor) && $valor != ""){						$nuevo[$clave] = trim(htmlspecialchars($_POST['tarjeta_'.$clave]));					}				}								/* Generamos la consulta */				$sql = "INSERT INTO mon_tarjetas (";				foreach($nuevo as $clave => $valor){					$sql .= $clave.", ";				}				$sql = substr($sql, 0, -2);				$sql .= ") VALUES (";				foreach($nuevo as $clave => $valor){					$sql .= "'".$valor."', ";				}				$sql = substr($sql, 0, -2);				$sql .= ")";						/* Si existe, lo actualizamos */			}else{								/* Generamos las variables que se van a insertar en la consulta. */				/* Si están vacías no se incluyen. */				foreach($tarjetas['0'] as $clave => $valor){					if(						($clave != "id_tarjetas") && 						(!empty($_POST['tarjeta_'.$clave])) && 						($_POST['tarjeta_'.$clave] != "")					){						$nuevo[$clave] = trim(htmlspecialchars($_POST['tarjeta_'.$clave]));					}				}								/* Generamos la consulta */				$sql = "UPDATE mon_tarjetas SET ";				foreach($nuevo as $clave => $valor){					$sql .= $clave."='".$valor."', ";				}				$sql = substr($sql, 0, -2);				$sql .= " WHERE id_tarjetas = '".$_POST['tarjeta_idtarjetas']."'";			}						/* Damos la orden a sql */			$resul = mysqli_query($conexion, $sql);			if(!$resul){				$error = mysqli_error($conexion);				include "error.php";				exit();			}		}				if(isset($_POST['borrar_tarjeta'])){					/* Seleccionamos las cabeceras de la tabla tarjetas */			$sql = "DELETE FROM mon_tarjetas WHERE id_tarjetas='".$_POST['borrar_tarjeta_id']."'";			$resul = mysqli_query($conexion, $sql);			if(!$resul){				$error = mysqli_error($conexion);				include "error.php";				exit();			}		}				/* Cargamos los datos de todas las tarjetas */		$sql = "SELECT * FROM mon_tarjetas";		$resul = mysqli_query($conexion, $sql);		if(!$resul){			$error = mysqli_error($conexion);			include "error.php";			exit();		}		$tarjetas = array();		while ($fila = mysqli_fetch_array($resul)){			$tarjetas[] = limpiar_array($fila);		}		include "vistas/vista_tarjetas.php";		exit();	}		/*	Tipos de cuenta */	if(isset($_GET['seccion']) && $_GET['seccion'] == "tipos_cuenta"){				if($_SESSION['administrador'] < 3){			header('Location: /admin');			exit();		}				if(isset($_POST['nuevo_tipo_cuenta'])){					/* Buscamos si existe el elemento que queremos crear */			$sql = "SELECT * FROM tipos_cuenta WHERE nombre='".$_POST['tipo_cuenta_nombre']."'";						$resul = mysqli_query($conexion, $sql);			if(!$resul){				$error = mysqli_error($conexion);				include "error.php";				exit();			}			$tipos_cuenta = array();			while($fila = mysqli_fetch_array($resul)){				$tipos_cuenta[] = limpiar_array($fila);			}						/* Si no hay ningún elemento con ese ID, lo creamos */			if(empty($tipos_cuenta)){							/* Seleccionamos las cabeceras de la tabla */				$sql = "SELECT * FROM tipos_cuenta LIMIT 1";				$resul = mysqli_query($conexion, $sql);				if(!$resul){					$error = mysqli_error($conexion);					include "error.php";					exit();				}				$tipos_cuenta = array();				while ($fila = mysqli_fetch_array($resul)){					$tipos_cuenta[] = limpiar_array($fila);				}								/* Generamos las variables que se van a insertar en la consulta */				foreach($tipos_cuenta['0'] as $clave => $valor){					if($clave != "id_tipos_cuenta"){						$nuevo[$clave] = trim(htmlspecialchars($_POST['tipo_cuenta_'.$clave]));					}				}								/* Generamos la consulta */				$sql = "INSERT INTO tipos_cuenta (";				foreach($nuevo as $clave => $valor){					$sql .= $clave.", ";				}				$sql = substr($sql, 0, -2);				$sql .= ") VALUES (";				foreach($nuevo as $clave => $valor){					$sql .= "'".$valor."', ";				}				$sql = substr($sql, 0, -2);				$sql .= ")";						/* Si existe, lo actualizamos */			}else{								/* Generamos las variables que se van a insertar en la consulta. */				/* Si están vacías no se incluyen. */				foreach($tipos_cuenta['0'] as $clave => $valor){					if(						($clave != "id_tipos_cuenta") && 						($clave != "nombre") && 						(!empty($_POST['tipo_cuenta_'.$clave])) && 						($_POST['tipo_cuenta_'.$clave] != "")					){						$nuevo[$clave] = trim(htmlspecialchars($_POST['tipo_cuenta_'.$clave]));					}				}								/* Generamos la consulta */				$sql = "UPDATE tipos_cuenta SET ";				foreach($nuevo as $clave => $valor){					$sql .= $clave."='".$valor."', ";				}				$sql = substr($sql, 0, -2);				$sql .= " WHERE nombre = '".$_POST['tipo_cuenta_nombre']."'";			}						/* Damos la orden a sql */			$resul = mysqli_query($conexion, $sql);			if(!$resul){				$error = mysqli_error($conexion);				include "error.php";				exit();			}		}				if(isset($_POST['borrar_tipos_cuenta'])){					/* Seleccionamos las cabeceras de la tabla idiomas */			$sql = "DELETE FROM tipos_cuenta WHERE id_tipos_cuenta='".$_POST['borrar_tipos_cuenta_id']."'";			$resul = mysqli_query($conexion, $sql);			if(!$resul){				$error = mysqli_error($conexion);				include "error.php";				exit();			}		}				/* Cargamos los datos de todos los tipos de cuenta */		$sql = "SELECT * FROM tipos_cuenta ORDER BY id_tipos_cuenta ASC";		$resul = mysqli_query($conexion, $sql);		if(!$resul){			$error = mysqli_error($conexion);			include "error.php";			exit();		}		$tipos_cuenta = array();		while ($fila = mysqli_fetch_array($resul)){			$tipos_cuenta[] = limpiar_array($fila);		}				include "vistas/vista_tipos_cuenta.php";		exit();	}	/*	Wallpapers */	if(isset($_GET['seccion']) && $_GET['seccion'] == "wallpapers"){				if($_SESSION['administrador'] < 3){			header('Location: /admin');			exit();		}				if(isset($_POST['nuevo_wallpaper'])){					/* Buscamos si existe el elemento que queremos crear */			$sql = "SELECT * FROM mon_wallpapers WHERE ruta = '".$_POST['wallpaper_ruta']."'";			$resul = mysqli_query($conexion, $sql);			if(!$resul){				$error = mysqli_error($conexion);				include "error.php";				exit();			}			$wallpapers = array();			while ($fila = mysqli_fetch_array($resul)){				$wallpapers[] = limpiar_array($fila);			}						/* Si no hay ningún wallpaper con ese ID, lo creamos */			if(empty($wallpapers)){							/* Seleccionamos las cabeceras de la tabla wallpapers */				$sql = "SELECT * FROM mon_wallpapers LIMIT 1";				$resul = mysqli_query($conexion, $sql);				if(!$resul){					$error = mysqli_error($conexion);					include "error.php";					exit();				}				$wallpapers = array();				while ($fila = mysqli_fetch_array($resul)){					$wallpapers[] = limpiar_array($fila);				}							/* Generamos las variables que se van a insertar en la consulta */				foreach($wallpapers['0'] as $clave => $valor){					if($clave != "id_wallpapers" && !empty($valor) && $valor != ""){						$nuevo[$clave] = trim(htmlspecialchars($_POST['wallpaper_'.$clave]));					}				}								/* Generamos la consulta */				$sql = "INSERT INTO mon_wallpapers (";				foreach($nuevo as $clave => $valor){					$sql .= $clave.", ";				}				$sql = substr($sql, 0, -2);				$sql .= ") VALUES (";				foreach($nuevo as $clave => $valor){					$sql .= "'".$valor."', ";				}				$sql = substr($sql, 0, -2);				$sql .= ")";						/* Si existe, lo actualizamos */			}else{								/* Generamos las variables que se van a insertar en la consulta. */				/* Si están vacías no se incluyen. */				foreach($wallpapers['0'] as $clave => $valor){					if(						($clave != "id_wallpapers") && 						($clave != "ruta") && 						(!empty($_POST['wallpaper_'.$clave])) && 						($_POST['wallpaper_'.$clave] != "")					){						$nuevo[$clave] = trim(htmlspecialchars($_POST['wallpaper_'.$clave]));					}				}								/* Generamos la consulta */				$sql = "UPDATE mon_wallpapers SET ";				foreach($nuevo as $clave => $valor){					$sql .= $clave."='".$valor."', ";				}				$sql = substr($sql, 0, -2);				$sql .= " WHERE ruta = '".$_POST['wallpaper_ruta']."'";			}						/* Damos la orden a sql */			$resul = mysqli_query($conexion, $sql);			if(!$resul){				$error = mysqli_error($conexion);				include "error.php";				exit();			}		}				if(isset($_POST['borrar_wallpapers'])){					/* Seleccionamos las cabeceras de la tabla idiomas */			$sql = "DELETE FROM mon_wallpapers WHERE id_wallpapers='".$_POST['borrar_wallpapers_id']."'";			$resul = mysqli_query($conexion, $sql);			if(!$resul){				$error = mysqli_error($conexion);				include "error.php";				exit();			}		}				/* Cargamos los datos de todos los wallpapers */		$sql = "SELECT * FROM mon_wallpapers ORDER BY id_wallpapers";		$resul = mysqli_query($conexion, $sql);		if(!$resul){			$error = mysqli_error($conexion);			include "error.php";			exit();		}		$wallpapers = array();		while ($fila = mysqli_fetch_array($resul)){			$wallpapers[] = limpiar_array($fila);		}		include "vistas/vista_wallpapers.php";		exit();	}		/*	Editar changelog */	if(isset($_GET['seccion']) && $_GET['seccion'] == "nuevo_changelog"){				if($_SESSION['administrador'] < 3){			header('Location: /admin');			exit();		}			if(isset($_POST['log_publicar'])){					/* Cargamos los datos del log */			$sql = "INSERT INTO mon_changelog (version, fecha, descripcion) VALUES ('".$_POST['version']."', now(), '".$_POST['descripcion']."')";			$resul = mysqli_query($conexion, $sql);			if(!$resul){				$error = mysqli_error($conexion);				include "error.php";				exit();			}						header("Location: /admin-changelog");			exit();		}				include "vistas/vista_editor_changelog.php";		exit();	}		/*	Changelogs */	if(isset($_GET['seccion']) && $_GET['seccion'] == "changelog"){				if($_SESSION['administrador'] < 3){			header('Location: /admin');			exit();		}				if(isset($_POST['log_publicar'])){			$version = trim(htmlspecialchars($_POST['version']));			$descripcion = trim($_POST['descripcion']);					/* Cargamos los datos del log */			$sql = "UPDATE mon_changelog SET version='pepe' AND descripcion='".$descripcion."' WHERE id_changelog='".$_POST['log_id']."'";			$resul = mysqli_query($conexion, $sql);			if(!$resul){				$error = mysqli_error($conexion);				include "error.php";				exit();			}							echo $sql;			exit();			}				else if(isset($_POST['log_editar'])){					/* Cargamos los datos del log */			$sql = "SELECT * FROM mon_changelog WHERE id_changelog='".$_POST['log_id']."'";			$resul = mysqli_query($conexion, $sql);			if(!$resul){				$error = mysqli_error($conexion);				include "error.php";				exit();			}			$changelog = array();			while ($fila = mysqli_fetch_array($resul)){				$changelog = limpiar_array($fila);			}						include "vistas/vista_editor_changelog.php";			exit();		}				else if(isset($_POST['log_borrar'])){					/* Seleccionamos las cabeceras de la tabla mensajes */			$sql = "DELETE FROM mon_changelog WHERE id_changelog='".$_POST['log_id']."'";			$resul = mysqli_query($conexion, $sql);			if(!$resul){				$error = mysqli_error($conexion);				include "error.php";				exit();			}		}				/* Cargamos los datos de todos los mensajes */		$sql = "SELECT * FROM mon_changelog ORDER BY version DESC";		$resul = mysqli_query($conexion, $sql);		if(!$resul){			$error = mysqli_error($conexion);			include "error.php";			exit();		}		$changelogs = array();		while ($fila = mysqli_fetch_array($resul)){			$changelogs[] = limpiar_array($fila);		}				include "vistas/vista_changelog.php";		exit();	}		/*	Textos */	if(isset($_GET['seccion']) && $_GET['seccion'] == "mensajes"){				if($_SESSION['administrador'] < 3){			header('Location: /admin');			exit();		}			if(isset($_POST['nuevo_mensaje'])){					/* Buscamos si existe el elemento que queremos crear */			$sql = "SELECT * FROM mon_mensajes WHERE id_mensajes = '".$_POST['mensaje_id_mensajes']."'";			$resul = mysqli_query($conexion, $sql);			if(!$resul){				$error = mysqli_error($conexion);				include "error.php";				exit();			}			$mensajes = array();			while ($fila = mysqli_fetch_array($resul)){				$mensajes[] = limpiar_array($fila);			}						/* Si no hay ningún mensaje con ese ID, lo creamos */			if(empty($mensajes)){							/* Seleccionamos las cabeceras de la tabla mensajes */				$sql = "SELECT * FROM mon_mensajes LIMIT 1";				$resul = mysqli_query($conexion, $sql);				if(!$resul){					$error = mysqli_error($conexion);					include "error.php";					exit();				}				$mensajes = array();				while ($fila = mysqli_fetch_array($resul)){					$mensajes[] = limpiar_array($fila);				}							/* Generamos las variables que se van a insertar en la consulta */				foreach($mensajes['0'] as $clave => $valor){					if(!empty($valor) && $valor != ""){						$nuevo[$clave] = trim(htmlspecialchars($_POST['mensaje_'.$clave]));					}				}								/* Generamos la consulta */				$sql = "INSERT INTO mon_mensajes (";				foreach($nuevo as $clave => $valor){					$sql .= $clave.", ";				}				$sql = substr($sql, 0, -2);				$sql .= ") VALUES (";				foreach($nuevo as $clave => $valor){					$sql .= "'".$valor."', ";				}				$sql = substr($sql, 0, -2);				$sql .= ")";						/* Si existe, lo actualizamos */			}else{								/* Generamos las variables que se van a insertar en la consulta. */				/* Si están vacías no se incluyen. */				foreach($mensajes['0'] as $clave => $valor){					if(						($clave != "id_mensajes") && 						(!empty($_POST['mensaje_'.$clave])) && 						($_POST['mensaje_'.$clave] != "")					){						$nuevo[$clave] = trim(htmlspecialchars($_POST['mensaje_'.$clave]));					}				}								/* Generamos la consulta */				$sql = "UPDATE mon_mensajes SET ";				foreach($nuevo as $clave => $valor){					$sql .= $clave."='".$valor."', ";				}				$sql = substr($sql, 0, -2);				$sql .= " WHERE id_mensajes = '".$_POST['mensaje_id_mensajes']."'";			}						/* Damos la orden a sql */			$resul = mysqli_query($conexion, $sql);			if(!$resul){				$error = mysqli_error($conexion);				include "error.php";				exit();			}		}				if(isset($_POST['borrar_mensaje'])){					/* Seleccionamos las cabeceras de la tabla mensajes */			$sql = "DELETE FROM mon_mensajes WHERE id_mensajes='".$_POST['borrar_mensaje_id']."'";			$resul = mysqli_query($conexion, $sql);			if(!$resul){				$error = mysqli_error($conexion);				include "error.php";				exit();			}		}				/* Cargamos los datos de todos los mensajes */		$sql = "SELECT * FROM mon_mensajes ORDER BY esES ASC";		$resul = mysqli_query($conexion, $sql);		if(!$resul){			$error = mysqli_error($conexion);			include "error.php";			exit();		}		$mensajes = array();		while ($fila = mysqli_fetch_array($resul)){			$mensajes[] = limpiar_array($fila);		}		include "vistas/vista_textos.php";		exit();	}		/* Cargamos la vista por defecto */	include "vistas/vista_inicio.php";	exit();
?>